# TSUBAME4ï¼ŒACBI3.0ï¼Œå²¡å´ç ”HPC ã‚’ç”¨ã„ãŸè©•ä¾¡æ–¹æ³•

> ç›®æ¬¡
> - [æ¦‚è¦](#æ¦‚è¦)
> - [æ›´æ–°å±¥æ­´](#æ›´æ–°å±¥æ­´)
> - [1. ç’°å¢ƒæ§‹ç¯‰](#1-ç’°å¢ƒæ§‹ç¯‰)
>   - [1.1 è©•ä¾¡è€…å›ºæœ‰æƒ…å ±ã®ç™»éŒ²](#11-è©•ä¾¡è€…å›ºæœ‰æƒ…å ±ã®ç™»éŒ²)
>   - [1.2 è©•ä¾¡è€…å›ºæœ‰æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰å¤‰æ›´](#12-è©•ä¾¡è€…å›ºæœ‰æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰å¤‰æ›´)
>   - [1.3 ç’°å¢ƒæ§‹ç¯‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ](#13-ç’°å¢ƒæ§‹ç¯‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ)
> - [2. è©•ä¾¡ã®å®Ÿè¡Œ](#2-è©•ä¾¡ã®å®Ÿè¡Œ)
>   - [2.1 ãƒ¢ãƒ‡ãƒ«ã®è¨­å®š](#21-ãƒ¢ãƒ‡ãƒ«ã®è¨­å®š)
>   - [2.2 ã‚¿ã‚¹ã‚¯ã®è¨­å®š](#22-ã‚¿ã‚¹ã‚¯ã®è¨­å®š)
>   - [2.3 è©•ä¾¡ã®å®Ÿè¡Œ](#23-è©•ä¾¡ã®å®Ÿè¡Œ)
>   - [2.4 è©•ä¾¡çµæœã®ç¢ºèª](#24-è©•ä¾¡çµæœã®ç¢ºèª)
>   - [2.5 è©•ä¾¡çµæœã®ç¢ºèª](#25-è©•ä¾¡çµæœã®ç¢ºèª)
>   - [2.6 è©•ä¾¡ãƒ­ã‚°ã®ç¢ºèª](#26-è©•ä¾¡ãƒ­ã‚°ã®ç¢ºèª)
>   - [2.7 è©•ä¾¡è©³ç´°ã®ç¢ºèªï¼ˆlightevalã‚’ç”¨ã„ãŸè©•ä¾¡ã®å ´åˆã®ã¿ï¼‰](27-è©•ä¾¡è©³ç´°ã®ç¢ºèªï¼ˆlightevalã‚’ç”¨ã„ãŸè©•ä¾¡ã®å ´åˆã®ã¿ï¼‰)
> - [3. Tips](#3-tips)
>   - [3.1 ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã™ã‚‹ã¨ãã«](#31-ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã™ã‚‹ã¨ãã«)
>   - [3.2 ãƒ¢ãƒ‡ãƒ«å›ºæœ‰ã®ç”Ÿæˆæ¡ä»¶ã‚’è¿½åŠ ã™ã‚‹ã¨ã](#32-ãƒ¢ãƒ‡ãƒ«å›ºæœ‰ã®ç”Ÿæˆæ¡ä»¶ã‚’è¿½åŠ ã™ã‚‹ã¨ã)
>   - [3.3 å„ãƒ¢ãƒ‡ãƒ«ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¤ã„ã¦](#33-å„ãƒ¢ãƒ‡ãƒ«ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¤ã„ã¦)
>   - [3.4 ç‰¹å®šã®providerã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã®å¯¾å¿œ](#34-ç‰¹å®šã®providerã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã®å¯¾å¿œ)
>   - [3.5 ä¸¦åˆ—å¿œç­”æ•°ã‚’å¼·åˆ¶çš„ã«1ã«ã™ã‚‹æ–¹æ³•](#35-ä¸¦åˆ—å¿œç­”æ•°ã‚’å¼·åˆ¶çš„ã«1ã«ã™ã‚‹æ–¹æ³•)
>   - [3.6 è©•ä¾¡ãŒã„ã¤ã¾ã§ãŸã£ã¦ã‚‚çµ‚ã‚ã‚‰ãªã„å ´åˆ](#36-è©•ä¾¡ãŒã„ã¤ã¾ã§ãŸã£ã¦ã‚‚çµ‚ã‚ã‚‰ãªã„å ´åˆ)
>   - [3.7 vLLMã®reasoning_parserãŒå¯¾å¿œã—ã¦ã„ãªã„æ¨è«–å‹ãƒ¢ãƒ‡ãƒ«](#37-vLLMã®reasoning_parserãŒå¯¾å¿œã—ã¦ã„ãªã„æ¨è«–å‹ãƒ¢ãƒ‡ãƒ«)
>   - [3.8 Baseãƒ¢ãƒ‡ãƒ«ã‚’ç„¡ç†ã‚„ã‚Šè©•ä¾¡ã™ã‚‹](#38-Baseãƒ¢ãƒ‡ãƒ«ã‚’ç„¡ç†ã‚„ã‚Šè©•ä¾¡ã™ã‚‹)

## æ¦‚è¦
ã“ã®è³‡æ–™ã¯ï¼Œå²¡å´ç ”ã®è©•ä¾¡ãƒãƒ¼ãƒ ãŒ TSUBAME4ï¼ŒABCI3.0ï¼Œå²¡å´ç ”HPC ä¸Šã§è©•ä¾¡ã‚’è¡Œã†éš›ã«å‚ç…§ã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ãŸï¼Œå†…éƒ¨å‘ã‘ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§ã‚ã‚‹ï¼

<details><summary>æ›´æ–°å±¥æ­´</summary>

| æ—¥ä»˜ | å†…å®¹ | æ‹…å½“ |
| -- | -- | -- |
| 2025/06/19 | åˆç¨¿ | é½‹è—¤ |
| 2025/07/01 | custom_settings ã¨ã‚¿ã‚¹ã‚¯ã®è¿½åŠ ã«é–¢ã—ã¦è¿½è¨˜ | é½‹è—¤ |
| 2025/07/02 | Providerå›ºæœ‰ã®å•é¡Œã¸ã®å¯¾å‡¦æ³•ã€ãƒ¢ãƒ‡ãƒ«å›ºæœ‰ã®ç”Ÿæˆæ¡ä»¶ã«é–¢ã™ã‚‹æ³¨æ„ã€è¨ˆç®—ãŒçµ‚ã‚ã‚‰ãªã„ã¨ãã®å¯¾å‡¦æ³•ã‚’Tipsã«è¿½è¨˜ | æ°´æœ¨ |
| 2025/07/07 | custom_model_settings ã«é–¢ã™ã‚‹è¿½è¨˜ãƒ»ä¿®æ­£ | é½‹è—¤ |
| 2025/07/25 | ABCIï¼Œlocal ã§ã®å®Ÿè¡Œã«é–¢ã™ã‚‹è¿½è¨˜ãƒ»ä¿®æ­£ | é½‹è—¤ |
| 2025/07/31 | ç‹¬è‡ªã®reasoning parserã‚’ä½¿ã†ã‚±ãƒ¼ã‚¹ã‚’è¿½è¨˜ | æ°´æœ¨ |
| 2025/08/04 | Baseãƒ¢ãƒ‡ãƒ«ã‚’ç„¡ç†ã‚„ã‚Šè©•ä¾¡ã™ã‚‹ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’è¿½è¨˜ | æ°´æœ¨ |

</details>

## 1. ç’°å¢ƒæ§‹ç¯‰
### 1.1 è©•ä¾¡è€…å›ºæœ‰æƒ…å ±ã®ç™»éŒ²
`.env_template` ã«è¨˜ã•ã‚Œã¦ã„ã‚‹ä»¥ä¸‹ã®å¤‰æ•°ã«ã¤ã„ã¦å„è©•ä¾¡è€…ã®ç’°å¢ƒã«åˆã‚ã›ã¦ä¿®æ­£ã‚’è¡Œã†ï¼

| ã‚«ãƒ†ã‚´ãƒª | å¤‰æ•°å | èª¬æ˜ | å‚™è€ƒ | 
| -- | -- | -- | -- |
| Paths | `GROUP_AND_NAME` | ä»¥ä¸‹ã®å¤‰æ•°ã®è¨­å®šã‚’ç°¡å˜ã«ã™ã‚‹ãŸã‚ã®å¤‰æ•°ï¼ | å¿…ãšã—ã‚‚ä½¿ã†å¿…è¦ã¯ãªã„ï¼ |
| Paths | `REPO_PATH` | è©•ä¾¡ãƒ¬ãƒã‚¸ãƒˆãƒªã®çµ¶å¯¾ãƒ‘ã‚¹ï¼| ãƒ‡ãƒãƒƒã‚°ãªã©ã§è¤‡æ•°ã®ãƒ¬ãƒã‚¸ãƒˆãƒªã‚’æŒã£ã¦ã„ã‚‹å ´åˆã¯æ³¨æ„ï¼ |
| Paths | `HUGGINGFACE_CACHE` | HuggingFace ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚„ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãªã©ã«é–¢ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ã—ã¦ãŠããƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ | å¿…ãš `/gs/bs/` ä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã™ã‚‹ã“ã¨ï¼ |
| Paths | `UV_CACHE` | UV ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãªã©ã«é–¢ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ã—ã¦ãŠããƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼| å®¹é‡ã¯ãã“ã¾ã§å¤§ãããªã‚‰ãªã„ã“ã¨ãŒæƒ³å®šã•ã‚Œã‚‹ãŒï¼Œå¿µã®ç‚º `/gs/bs/` ä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã™ã‚‹ã¨ã‚ˆã„ï¼|
| Paths | `VLLM_CACHE` | VLLM ã®å‹•ä½œã«é–¢ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ã—ã¦ãŠããƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼| å®¹é‡ãŒã©ã‚Œã»ã©å ã‚ã‚‰ã‚Œã‚‹ã‹ã¯æŠŠæ¡ã—ã¦ã„ãªã„ãŒï¼Œå¿µã®ç‚º`/gs/bs/` ä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã™ã‚‹ã¨ã‚ˆã„ï¼|
| Groups | `TSUBAME_GROUP` | è©•ä¾¡ã«ç”¨ã„ã‚‹ TSUBAME ã®ã‚°ãƒ«ãƒ¼ãƒ— | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å²¡å´ç ”ã®ã‚‚ã®ã«ãªã£ã¦ã„ã‚‹ï¼ |
| Groups | `ABCI_GROUP` | è©•ä¾¡ã«ç”¨ã„ã‚‹ ABCI ã®ã‚°ãƒ«ãƒ¼ãƒ— | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç”£ç·ç ”ã®ã‚‚ã®ã«ãªã£ã¦ã„ã‚‹ï¼ |
| APIs | `OPENAI_API_KEY` | MT-Bench ã®è©•ä¾¡ã«ãŠã‘ã‚‹ LLM-as-a-judge ã§ OpanAI ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã¨ãã‚„ï¼ŒOpenAI ã®ãƒ¢ãƒ‡ãƒ«ã‚’è©•ä¾¡ã™ã‚‹ã‚ˆãã«ä½¿ç”¨ã™ã‚‹ï¼ | Swallow project ç”¨ã® API ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ï¼ãŠé‡‘ã‚’æ¶ˆè²»ã™ã‚‹ã®ã§è¦æ³¨æ„ï¼|
| APIs | `DEEPINFRA_API_KEY` | DeepInfra ã®ãƒ¢ãƒ‡ãƒ«ã‚’è©•ä¾¡ã™ã‚‹ã‚ˆãã«ä½¿ç”¨ã™ã‚‹ï¼ | Swallow project ç”¨ã® API ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ï¼ãŠé‡‘ã‚’æ¶ˆè²»ã™ã‚‹ã®ã§è¦æ³¨æ„ï¼|
| APIs | `HF_TOKEN` | HuggingFace ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚„ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã«ç”¨ã„ã‚‰ã‚Œã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ï¼| Rate Limit ã®ç·©å’Œã‚„ä½¿ç”¨è¨±å¯ãŒå¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãƒ»ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹éš›ã«å¿…è¦ï¼|

### 1.2 è©•ä¾¡è€…å›ºæœ‰æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰å¤‰æ›´
1.1 ã§è©•ä¾¡è€…å›ºæœ‰æƒ…å ±ã‚’è¨˜è¼‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰ã‚’`.env_template` ã‹ã‚‰ `.env` ã«å¤‰æ›´ã—ã¦ãŠãï¼ \
ã“ã‚Œã«ã‚ˆã‚Šè©•ä¾¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰èª­ã¿å–ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šï¼Œã¾ãŸï¼Œ`gitignore` ã®å¯¾è±¡ã¨ãªã‚‹ï¼
> âš ï¸ æ³¨æ„ï¼š \
> `.env` ã«ã¯ã€€API ã‚­ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚æ±ºã—ã¦ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã«å…¬é–‹ã—ã¦ã¯ãªã‚‰ãªã„ï¼

### 1.3 ç’°å¢ƒæ§‹ç¯‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
1.1ï¼Œ1.2 ã§æ­£ã—ãè©•ä¾¡è€…å›ºæœ‰æƒ…å ±ãŒç™»éŒ²ã§ãã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸä¸Šã§ï¼Œä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ï¼Œç’°å¢ƒæ§‹ç¯‰ã‚’è¡Œã†ï¼
```bash
# ä»¥ä¸‹ã¯ Saito ã®ä¾‹
cd /gs/fs/tga-okazaki/saito/swallow-evaluation-instruct-private
bash scripts/qsub/environment/setup_t4_uv_envs.sh
```

æœ€çµ‚çš„ã« `"âœ… Environment was successfully created!"` ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸï¼


## 2. è©•ä¾¡ã®å®Ÿè¡Œ
### 2.1 ãƒ¢ãƒ‡ãƒ«ã®è¨­å®š
ã¾ãšï¼Œè©•ä¾¡ã‚’è¡Œã†ãƒ¢ãƒ‡ãƒ«ã«ã¤ã„ã¦ä»¥ä¸‹ã®æƒ…å ±ã‚’`scripts/qsub/qsub_all.sh`ã® `# Set Args` ã®æ¬„ã«æ›¸ãè¾¼ã‚€ï¼

| ã‚«ãƒ†ã‚´ãƒª | å¤‰æ•°å | èª¬æ˜ | å‚™è€ƒ |
| -- | -- | -- | -- |
| Common | `NODE_KIND` | ä½¿ã„ãŸã„ãƒãƒ¼ãƒ‰ï¼<br> tsubame ["node_q", "node_f", "cpu_16"]ï¼Œ<br> abci ["rt_HG", "rt_HF", "rt_HC"]ï¼Œ<br> local ["gpu_*" (*ã¯GPUã®æ•°), "cpu"] | 13Bä»¥ä¸‹ãªã‚‰"node_q"ã‚„"rt_HG"ã‚„"gpu_2"ï¼Œ<br> 13Bè¶…ãªã‚‰"node_f"ã‚„"rt_HF"ã‚„"gpu_4"ï¼Œ<br> OpenAIã‚„DeepInfraã®APIã‚’ä½¿ã†ãªã‚‰"cpu_16"ã‚„"rt_HC"ã‚„"cpu"ã‚’é¸ã¶ã¨è‰¯ã„ï¼|
| Common | `MODEL_NAME`| è©•ä¾¡ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã®HuggingFaceIDï¼| HuggingFaceã®ãƒ¢ãƒ‡ãƒ«ã‚«ãƒ¼ãƒ‰ä¸Šéƒ¨ã«ã‚ã‚‹ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‹ã‚‰å–å¾—ã§ãã‚‹ï¼openAIã®modelã«é–¢ã—ã¦ã¯ã€openai/~ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã€‚|
| Special | `PROVIDER` | è©•ä¾¡ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’ serve ã™ã‚‹ãŸã‚ã® providerï¼| HuggingFaceã®ãƒ¢ãƒ‡ãƒ«ã§ã‚ã‚Œã°"vllm"ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ï¼ŒOpenAI ã®ãƒ¢ãƒ‡ãƒ«ãªã‚‰"openai"ã‚’æŒ‡å®šï¼Deepinfra ã‚’ä½¿ã†å ´åˆã¯"deepinfra"ã‚’æŒ‡å®šã™ã‚‹ï¼|
| Special | `CUSTOM_SETTINGS` | ä½¿ã„ãŸã„ custom model settings ã®åå‰ï¼| ä¾‹ï¼š`default`ï¼Œ`reasoning`ï¼Œ`code`ï¼ |
| Special | `PREDOWNLOAD_MODEL` | ã‚¸ãƒ§ãƒ–ã‚’æŠ•ã’ã‚‹å‰ã« HuggingFace ã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã©ã†ã‹ã®è¨­å®šï¼| OpenAI ã‚„ DeepInfra ã®ãƒ¢ãƒ‡ãƒ«ã‚’è©•ä¾¡ã™ã‚‹å ´åˆã¯å¿…ãš `false` ã«ã™ã‚‹ã“ã¨ï¼ |
| Special | `MAX_SAMPLES` | è©•ä¾¡ã«ç”¨ã„ã‚‹ã‚µãƒ³ãƒ—ãƒ«æ•°ã®ä¸Šé™ï¼ | ä¸»ã«ãƒ‡ãƒãƒƒã‚°ã®æ™‚ã«ç”¨ã„ã‚‹ï¼ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç„¡åˆ¶é™ï¼| 
| Environmental | `SERVICE` | è©•ä¾¡ã«ä½¿ã†ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆå®Ÿè¡Œç’°å¢ƒï¼‰| tsubameï¼ˆTSUBAME4ï¼‰ï¼Œabciï¼ˆABCI3.0ï¼‰ï¼Œlocalï¼ˆå²¡å´ç ”HPCï¼‰ã«å¯¾å¿œã—ã¦ã„ã‚‹ï¼ |
| Environmental | `PRIORITY` | ä½¿ã„ãŸã„TSUBAME4ã«ãŠã‘ã‚‹å„ªå…ˆåº¦ï¼["-5", "-4", "-3"] | æ•°å€¤ãŒå¤§ãã„æ–¹ãŒã‚¸ãƒ§ãƒ–ãŒæµã‚Œã‚„ã™ããªã‚‹ï¼ã—ã‹ã—ï¼Œãã‚Œã«å¿œã˜ã¦å€¤æ®µãŒ2å€ï¼Œ4å€ã¨é«˜ããªã‚‹ã®ã§ï¼ŒæŒ‡å®šã™ã‚‹å ´åˆã¯è¦ç›¸è«‡ï¼|
| Environmental | `CUDA_VISIBLE_DEVICES` | local ã§ä½¿ã„ãŸã„ GPU ãƒªã‚½ãƒ¼ã‚¹ã®æŒ‡å®šï¼| |



> ğŸ“ Note: \
> ä»¥ä¸‹ã®å¤‰æ•°ã¯ custom model setetings ã§è¨­å®šã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ãŸï¼(å‚ç…§ï¼š [3.2 ãƒ¢ãƒ‡ãƒ«å›ºæœ‰ã®ç”Ÿæˆæ¡ä»¶ã‚’è¿½åŠ ã™ã‚‹ã¨ã](#32-ãƒ¢ãƒ‡ãƒ«å›ºæœ‰ã®ç”Ÿæˆæ¡ä»¶ã‚’è¿½åŠ ã™ã‚‹ã¨ã) ï¼‰\
> `SYSTEM_MESSAGE`ï¼Œ`MAX_MODEL_LENGTH`ï¼Œ`MAX_NEW_TOKENS`

> ğŸ“ Noteï¼š \
> openaiã‚„deepinfraã®ã‚ˆã†ãªAPIã‚’ä½¿ã†å ´åˆã¯localã§ã®å®Ÿè¡Œã‚’æ¨å¥¨ã™ã‚‹ï¼

### 2.2 ã‚¿ã‚¹ã‚¯ã®è¨­å®š
2.1 ã§ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã‚’çµ‚ãˆãŸã‚‰ \
åŒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`scripts/tsubame/qsub_all.sh`ï¼‰ä¸‹éƒ¨ã® `# Submit tasks` ä»¥é™ã‚’ç·¨é›†ã—ï¼Œ \
è©•ä¾¡ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’æŒ‡å®šã™ã‚‹ï¼å…·ä½“çš„ã«ã¯ï¼Œè©•ä¾¡ã—ãªã„ã‚¿ã‚¹ã‚¯ã«ã¤ã„ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’ã™ã‚Œã°è‰¯ã„ï¼

### 2.3 è©•ä¾¡ã®å®Ÿè¡Œ
2.1ï¼Œ2.2 ã§ãƒ¢ãƒ‡ãƒ«ã¨ã‚¿ã‚¹ã‚¯ã®æŒ‡å®šã‚’æ­£ã—ãè¡Œã£ãŸã“ã¨ã‚’ç¢ºèªã—ãŸã®ã¡ï¼Œä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è©•ä¾¡ã®ã‚¸ãƒ§ãƒ–ã‚’æŠ•ã’ã‚‹ã“ã¨ãŒã§ãã‚‹ï¼
```sh
# ä»¥ä¸‹ã¯ Saito ã®ä¾‹
cd /gs/fs/tga-okazaki/saito/swallow-evaluation-instruct-private
bash scripts/qsub/qsub_all.sh
```

### 2.4 è©•ä¾¡çŠ¶æ³ã®ç¢ºèª
ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰è©•ä¾¡çŠ¶æ³ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã‚‹ï¼
```sh
# ä»¥ä¸‹ã¯ Saito ã®ä¾‹
cd /gs/fs/tga-okazaki/saito/swallow-evaluation-instruct-private
bash scripts/qsub/utils/save_and_check_qstat.sh
```

### 2.5 è©•ä¾¡çµæœã®ç¢ºèª
è©•ä¾¡çµæœï¼ˆ`aggregated_results.json`ï¼‰ã¯ \
å„ãƒ¢ãƒ‡ãƒ«ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆ`results/{provider}/{model_publisher}/{model_name}/{custom_settings}`ï¼‰ä»¥ä¸‹ã«ä¿å­˜ã•ã‚Œã‚‹ï¼ \
è©•ä¾¡æ‹…å½“è€…ã¯ `aggregated_results.json` å†…ã® `overall`ã®å€¤ã‚’ï¼ŒæŒ‡å®šã•ã‚ŒãŸ spreadsheet ã«ã‚³ãƒ”ãƒ¼ã™ã‚Œã°è‰¯ã„ï¼

ã¡ãªã¿ã«è©•ä¾¡çµæœã«ã¯è©•ä¾¡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚„è©•ä¾¡ã‚¿ã‚¹ã‚¯ã«åŠ ãˆï¼Œä½¿ç”¨ã—ãŸ custom_settings ã®è©³ç´°ã‚‚è¨˜ã•ã‚Œã¦ã„ã‚‹ï¼ \
ã‚‚ã¡ã‚ã‚“ custom_settings ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„å ´åˆã«ã¯ä½•ã‚‚è¨˜ã•ã‚Œãªã„ï¼


### 2.6 è©•ä¾¡ãƒ­ã‚°ã®ç¢ºèª
è©•ä¾¡ã®ãƒ­ã‚°ï¼ˆæ¨™æº–å‡ºåŠ› `.o`/`.OU` ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ› `.e`/`.ER` ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã¯ \
å„ãƒ¢ãƒ‡ãƒ«ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆ`results/{provider}/{model_publisher}/{model_name}/{custom_settings}`ï¼‰ä»¥ä¸‹ã«è¨€èªãƒ»ã‚¿ã‚¹ã‚¯ã”ã¨ã«ä¿å­˜ã•ã‚Œã‚‹ï¼


### 2.7 è©•ä¾¡è©³ç´°ã®ç¢ºèªï¼ˆlightevalã‚’ç”¨ã„ãŸè©•ä¾¡ã®å ´åˆã®ã¿ï¼‰
è©•ä¾¡çµæœã®è©³ç´°ã¯ `lighteval/outputs/results` ä»¥ä¸‹ã« `.json` ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ï¼Œ \
ãƒ¢ãƒ‡ãƒ«ãŒç”Ÿæˆã—ãŸå›ç­”ã®è©³ç´°ã¯ `lighteval/outputs/outputs` ä»¥ä¸‹ã« `.pqt` ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ï¼ \
`.pqt`ãƒ•ã‚¡ã‚¤ãƒ«ã¯ pandas ã‚’ç”¨ã„ã¦ dataframe ã¨ã—ã¦é–‹ãã“ã¨ãŒã§ãã‚‹ï¼ \
ï¼ˆ`scripts/utils/details_viewer.ipynb`å‚ç…§ï¼‰

ã“ã‚Œã‚‰ã®jsonãƒ•ã‚¡ã‚¤ãƒ«ãŠã‚ˆã³pqtãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…±æœ‰ã—ãŸã„å ´åˆã¯ï¼Œlightevalã«æ­è¼‰ã•ã‚Œã¦ã„ã‚‹HuggingFace Datasetsè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’ä½¿ã†ã¨ã‚ˆã„ï¼Ref. [Saving and reading results](https://huggingface.co/docs/lighteval/v0.8.0/en/saving-and-reading-results) \
ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã®é€šã‚Šï¼äº‹å‰ã«HuggingFace CLIã«ã‚ˆã‚‹èªè¨¼ã‚’æ¸ˆã¾ã›ã¦ãŠãã“ã¨ï¼  
ãªãŠDatasetsã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§privateè¨­å®šãªã®ã§ï¼Œæ„å›³ã—ãªã„é™ã‚Šã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹ã•ã‚Œã‚‹ã“ã¨ã¯ãªã„ï¼  

```
lighteval endpoint litellm \
    (ä¸­ç•¥)
    --save-details \
    --push-to-hub \
    --results-org "{ã‚ãªãŸãŒå±ã—ã¦ã„ã‚‹HuggingFace Organization ID}" # ãŸã¨ãˆã°ã€€tokyotech-llm
```


## 3. ãã®ä»–
### 3.1 ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã™ã‚‹ã¨ãã«
ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã™ã‚‹éš›ã«ã¯ `lighteval/src/ligtheval/tasks/swallow/` ä»¥ä¸‹ã«ã‚¿ã‚¹ã‚¯ã®å®šç¾©ã‚’æ›¸ãï¼ \
ã—ã‹ã—ï¼Œãã®æ“ä½œã¯ã‚ãã¾ã§ lighteval ã«å¯¾ã™ã‚‹ã®æ“ä½œã§ã‚ã‚Šï¼Œswallow-evaluation-instruct ç”¨ã«ã¯è¿½åŠ ã®æ“ä½œãŒå¿…è¦ã§ã‚ã‚‹ï¼ \
ä»¥ä¸‹ã«ãã‚Œã‚’ã¾ã¨ã‚ã‚‹ï¼

| ã‚«ãƒ†ã‚´ãƒª | å¿…è¦æ€§ | æ“ä½œå¯¾è±¡ | æ“ä½œå†…å®¹ |
| -- | -- | -- | -- |
| çµæœé›†ç´„ï¼ˆAggregateï¼‰ã®ãŸã‚ã®æ“ä½œ | å¿…é ˆ | `scripts/aggregate_utils/conf.py` | è¿½åŠ ã—ãŸã‚¿ã‚¹ã‚¯ã«å¯¾å¿œã™ã‚‹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å®šç¾©ã™ã‚‹| 
| | é©å®œ |`scripts/aggregate_utils/funcs.py` | è¿½åŠ ã—ãŸã‚¿ã‚¹ã‚¯ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«å¿…è¦ãªè¨ˆç®—ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ |
| | é©å®œ |`scripts/aggregate_utils/white_lists.py` | è¿½åŠ ã—ãŸã‚¿ã‚¹ã‚¯ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¨ˆç®—ã«ç”¨ã„ã‚‹ã‚¿ã‚¹ã‚¯ã‚µãƒ–ã‚»ãƒƒãƒˆã®ã‚µãƒ–ã‚»ãƒƒãƒˆã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ |
| è©•ä¾¡å®Ÿè¡Œã®ãŸã‚ã®æ“ä½œ | å¿…é ˆ | `scripts/qsub/conf/tasks_runtime.csv` | è¿½åŠ ã—ãŸã‚¿ã‚¹ã‚¯ã«ã¤ã„ã¦ï¼Œ`key`ï¼ˆ"{è¨€èª}_{ã‚¿ã‚¹ã‚¯å}"ï¼‰ï¼Œ`script`ï¼ˆå®šç¾©ã—ãŸã‚¿ã‚¹ã‚¯åï¼‰ï¼Œ`result_dir`ï¼ˆçµæœãƒ»ãƒ­ã‚°ã®å‡ºåŠ›å…ˆï¼‰ï¼Œ`framework`ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼‰ï¼Œ`hrt_q`ï¼ˆnode_qã§ã®æƒ³å®šæ‰€è¦æ™‚é–“ï¼‰ï¼Œ`hrt_f`ï¼ˆnode_fã§ã®æƒ³å®šæ‰€è¦æ™‚é–“ï¼‰ï¼Œ`wlt_HG`ï¼ˆrt_HGã§ã®æƒ³å®šæ‰€è¦æ™‚é–“ï¼‰ï¼Œ`wlt_HF`ï¼ˆrt_HFã§ã®æƒ³å®šæ‰€è¦æ™‚é–“ï¼‰ï¼Œã‚’å®šç¾©ã™ã‚‹ |
| | å¿…é ˆ | `scripts/qsub/qsub_all.sh` | è¿½åŠ ã—ãŸã‚¿ã‚¹ã‚¯ã«ã¤ã„ã¦ï¼Œ`qsub_task {è¨€èª} {ã‚¿ã‚¹ã‚¯å}` ã‚’æœ«å°¾ã®é©å½“ãªç®‡æ‰€ã«è¿½åŠ ã™ã‚‹ï¼|
| | å¿…é ˆ | `scripts/generation_settings/task_settings.csv` | è¿½åŠ ã—ãŸã‚¿ã‚¹ã‚¯å›ºæœ‰ã®ç”Ÿæˆæ¡ä»¶ã‚’è¨˜ã™ï¼ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯`temperature=0.0`ï¼ã‚­ãƒ¼ã¨ãƒãƒªãƒ¥ãƒ¼ã¯"="ã§ç¹‹ãï¼Œè¤‡æ•°ã®æ¡ä»¶ã‚’å®šç¾©ã—ãŸã„å ´åˆã¯","ã§ç¹‹ãï¼|


### 3.2 ãƒ¢ãƒ‡ãƒ«å›ºæœ‰ã®ç”Ÿæˆæ¡ä»¶ã‚’è¿½åŠ ã™ã‚‹ã¨ã
ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã£ã¦ã¯æ„å›³ã—ãŸæ¨è«–ã‚’ã•ã›ã‚‹ãŸã‚ã« temperature ã‚„ system message ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼ \
ãã‚Œã‚‰ã®æŒ‡å®šã¯ `scripts/generation_settings/custom_model_settings` ä»¥ä¸‹ã« \
model publisher ã”ã¨ï¼Œmodel name ã”ã¨ã« .yaml ãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ï¼

ä¾‹ãˆã°ï¼Œ`tokyotech-llm/Llama-3.1-Swallow-8B-Instruct-v0.3` ã«ã¤ã„ã¦ã®æŒ‡å®šã‚’è¿½åŠ ã—ãŸã„å ´åˆã¯ \
`scripts/generation_settings/custom_model_settings/tokyotech-llm/Llama-3.1-Swallow-8B-Instruct-v0.3.yaml` \
ã«å®šç¾©ã‚’è¡Œãˆã°è‰¯ã„ï¼

å…·ä½“çš„ãªå®šç¾©ã®ä¾‹ã‚„å®šç¾©ã§ãã‚‹ãƒ‘ãƒ©ãƒ¡ã‚¿ã«ã¤ã„ã¦ã¯ã€€\
`scripts/generation_settings/custom_model_settings/template.yaml` ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ï¼\
å¿…è¦ã«å¿œã˜ã¦ã“ã® `template.yaml` ã‚’è¤‡è£½ã™ã‚‹ãªã©ã—ã¦æ´»ç”¨ã—ã¦ã»ã—ã„ï¼

> âš ï¸æ³¨æ„ï¼š \
> temperature ã‚’æŒ‡å®šã™ã‚‹ custom_model_settings ã¯ï¼Œ\
> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®temperatureãŒ0ã«ãªã£ã¦ã„ã‚‹ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã«å¯¾ã—ã¦ã®ã¿ï¼Œé©ç”¨ã™ã‚‹ã“ã¨ï¼ \
> MT-Benchã‚„LiveCodeBenchã®ã‚ˆã†ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®temperatureãŒ0ã§ãªã„ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã¯ï¼Œ\
> ç‰¹åˆ¥ãªè¦æ±‚ãŒãªã„é™ã‚Šï¼Œcustom_model_settings ã‚’æŒ‡å®šã—ãªã„ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ï¼

> ğŸ—’ï¸Note: \
> ç‰¹å®šã®æ¨è«–ãŒå¿…è¦ãªå ´åˆï¼ŒåŸå‰‡ï¼Œè©•ä¾¡ä¾é ¼è€…ãŒè©•ä¾¡ä¾é ¼æ™‚ã«ç”Ÿæˆæ¡ä»¶ã‚’æŒ‡å®šã™ã‚‹ï¼ \
> ã—ã‹ã—ï¼Œå ´åˆã«ã‚ˆã£ã¦ã¯ä¾é ¼è€…ãŒå‹˜é•ã„ã‚„æŒ‡å®šæ¼ã‚Œã‚’ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã†ã‚‹ï¼ \
> ãã®ãŸã‚ä»¥ä¸‹ã®ã‚±ãƒ¼ã‚¹ã«è©²å½“ã™ã‚‹ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšç”Ÿæˆæ¡ä»¶ã®æŒ‡å®šãŒãªã„å ´åˆã¯ï¼Œå¿µã®ç‚ºï¼Œä¾é ¼è€…ã«å¯¾ã—ã¦å†ç¢ºèªã—ã¦ã»ã—ã„ï¼š 
> * ãƒ¢ãƒ‡ãƒ«ã‚«ãƒ¼ãƒ‰ã§æ¨å¥¨ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ˜ç¤ºã•ã‚Œã¦ã„ã‚‹ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšï¼ŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„
> * ãƒ¢ãƒ‡ãƒ«ã‚«ãƒ¼ãƒ‰ã§æ¨è«–ãƒ¢ãƒ¼ãƒ‰ã‚’onã«ã™ã‚‹æ¡ä»¶ãŒæ˜ç¤ºã•ã‚Œã¦ã„ã‚‹ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšï¼ŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„

### 3.3 å„ãƒ¢ãƒ‡ãƒ«ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¤ã„ã¦
[2.5 è©•ä¾¡çµæœã®ç¢ºèª](#25-è©•ä¾¡çµæœã®ç¢ºèª)ã‚„[2.6 è©•ä¾¡ãƒ­ã‚°ã®ç¢ºèª](#26-è©•ä¾¡ãƒ­ã‚°ã®ç¢ºèª)ã§ã€Œå„ãƒ¢ãƒ‡ãƒ«ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ã¨ã—ã¦ \
`results/{provider}/{model_publisher}/{model_name}/{custom_settings}` ã¨ã„ã†ãƒ‘ã‚¹ã‚’è¨˜ã—ã¦ã„ã‚‹ãŒï¼Œ
ã“ã®ãƒ‘ã‚¹ã«å«ã¾ã‚Œã‚‹å„è¦ç´ ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã‚ã‚‹ï¼

| è¡¨è¨˜ | æ„å‘³ |
| -- | -- |
| `{provider}` | ãƒ¢ãƒ‡ãƒ«ã‚’serveï¼ˆç«‹ã¦ã‚‹ï¼‰ã‚µãƒ¼ãƒ“ã‚¹ã®åå‰ï¼vllmã®å ´åˆã¯`hosted_vllm`ï¼Œdeepinfraã®å ´åˆã¯`deepinfra`ï¼Œopenaiã®å ´åˆã¯ç©ºæ–‡å­—ã¨ãªã‚‹ï¼|
| `{model_publisher}` | Huggingface Model ID ã‚’"/"ã§åŒºåˆ‡ã£ãŸæ™‚ã®å‰åŠéƒ¨åˆ†ï¼ãƒ¢ãƒ‡ãƒ«ã‚’æä¾›ã™ã‚‹å›£ä½“ã‚’æŒ‡ã™ï¼ï¼ˆe.g. `tokyotech-llm`ï¼‰
| `{model_name}` | Huggingface Model ID ã‚’"/"ã§åŒºåˆ‡ã£ãŸæ™‚ã®å¾ŒåŠéƒ¨åˆ†ï¼ãƒ¢ãƒ‡ãƒ«åã‚’æŒ‡ã™ï¼ï¼ˆe.g. `Llama-3.1-Swallow-8B-Instruct-v0.3`ï¼‰
| `{custom_settings}` | ãƒ¢ãƒ‡ãƒ«å›ºæœ‰ã®ç‰¹åˆ¥ãªç”Ÿæˆæ¡ä»¶ï¼æŒ‡å®šã—ã¦ã„ãªã„å ´åˆã¯ç©ºæ–‡å­—ã¨ãªã‚‹ï¼ |

ãªãŠï¼Œ`{provider}` ã¨ `{custom_settings}` ã«ã¤ã„ã¦ã¯ç©ºæ–‡å­—ã¨ãªã‚Šã†ã‚‹ãŒï¼Œãã®å ´åˆãƒ‘ã‚¹å†…ã§ç©ºæ–‡å­—ã¯ç«¯æŠ˜ã‚‰ã‚Œã‚‹ï¼ \
ï¼ˆe.g. `results//tokyotech-llm/swallow/` -> `results/tokyotech-llm/swallow`ï¼‰

### 3.4 ç‰¹å®šã®providerã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã®å¯¾å¿œ

ç‰¹å®šã®providerã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã¯ï¼Œproviderå›ºæœ‰ã®åˆ¶é™ã«æŠµè§¦ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ï¼\
ãŸã¨ãˆã° `deepinfra/meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8` ã§ã¯ä¸¦åˆ—å¿œç­”æ•° `n` ã«5ä»¥ä¸Šã‚’æŒ‡å®šã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã‚’èµ·ã“ã™ï¼ˆ2025å¹´6æœˆæ™‚ç‚¹ï¼‰ï¼   \
ã“ã®ã‚ˆã†ãªå ´åˆã¯ï¼ŒJupyter Notebookãªã©ã‚’ç”¨ã„ã¦providerã«é©å½“ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ï¼Œèª¿æŸ»ã‚’è¡Œãªã£ã¦ã»ã—ã„ï¼

å…·ä½“ä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šï¼  
```
# deepinfra/meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8 ã®ä¾‹

import litellm

request_payload = {
    "model": "deepinfra/meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8",
    "messages": [
        {
            "role": "user",
            "content": (
                "ã“ã‚“ã«ã¡ã¯ã€‚ãªã«ã‹ã—ã‚ƒã¹ã£ã¦"
            ),
        }
    ],
    "logprobs": None,
    "base_url": "https://api.deepinfra.com/v1/openai",
    "n": 2,
    "caching": False,
    "api_key": "DeepInfraã®APIã‚­ãƒ¼",
    "max_completion_tokens": 512,
    "temperature": 1.0
}

responses = litellm.completion(**request_payload)
```

### 3.5 ä¸¦åˆ—å¿œç­”æ•° `n` ã‚’å¼·åˆ¶çš„ã«1ã«ã™ã‚‹æ–¹æ³•

JHumanEval ã‚„ LiveCodeBench ã®ã‚ˆã†ã« "Nå›è§£ã„ã¦æ­£ç­”ç‡ã‚’æ¸¬å®šã™ã‚‹" ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§ã¯ï¼Œ\
ä¸¦åˆ—å¿œç­”æ•° `n` ã‚’Nï¼ˆãŸã¨ãˆã°JHumanEvalãªã‚‰N=10ï¼‰ã§è¨­å®šã—ã¦ã„ã‚‹ï¼ \
providerãŒä¸¦åˆ—å¿œç­”æ•°ã‚’åˆ¶é™ã—ã¦ã„ã¦ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å ´åˆãªã©ã¯ generation_parameters ã« `max_n` ã®æŒ‡å®šã‚’è¿½åŠ ã—ã¦ã»ã—ã„ï¼

å…·ä½“ä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šï¼ˆä¸Šï¼šgeneration_parametersã«è¿½è¨˜ã™ã‚‹ä¾‹ï¼ä¸‹ï¼šæ‰‹å…ƒã§æ¤œè¨¼ã‚’è¡Œã†ä¾‹ï¼ï¼‰
```yaml
max_n_specified:
  max_n: "4"
  version: "1"
```

```
lighteval endpoint litellm \
    "model=$MODEL_NAME,api_key=$API_KEY,base_url=$BASE_URL,generation_parameters={temperature:0.2,top_p:0.95,max_n:4}" \
    "swallow|lcb:codegeneration_v5_6|0|0" \
    ...
```

### 3.6 è©•ä¾¡ãŒã„ã¤ã¾ã§ãŸã£ã¦ã‚‚çµ‚ã‚ã‚‰ãªã„å ´åˆ

è©•ä¾¡ãŒã„ã¤ã¾ã§ãŸã£ã¦ã‚‚çµ‚ã‚ã‚‰ãªã„å ´åˆã¯ï¼Œ\
1 ) ä¸¦åˆ—å‡¦ç†æ•°ãŒå°‘ãªã™ãã‚‹ 2 ) repetitionãŒå¤šç™ºã—ã¦vLLMã®ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãŒæ¥µç«¯ã«ä½ä¸‹ã—ã¦ã„ã‚‹ ã¾ãŸã¯ 3 ) è¨ˆç®—è³‡æºãŒè¶³ã‚Šãªã„ ãŒç–‘ã‚ã‚Œã‚‹ï¼ \
ã“ã®ã‚ˆã†ãªå ´åˆã¯GPUã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚„vLLMãƒ­ã‚°ã‚’è¦‹ã¦ï¼Œã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã®æ¥µç«¯ãªä½ä¸‹ã‚„KV Cacheä¸è¶³ã®WARNINGå¤šç™ºãªã©åŸå› ã®æ‰‹ãŒã‹ã‚Šã‚’ç¢ºèªã—ã¦ã»ã—ã„ï¼
- Ref. [vLLM Optimization and Tuning](https://docs.vllm.ai/en/latest/configuration/optimization.htm)

#### 1) ä¸¦åˆ—å‡¦ç†æ•°ãŒå°‘ãªã™ãã‚‹

`nvidia-smi` ã‚³ãƒãƒ³ãƒ‰ç­‰ã§è¡¨ç¤ºã§ãã‚‹GPUã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ä½¿ç”¨ç‡ãŒ80%æœªæº€ã®å ´åˆã¯ï¼Œæ¨è«–ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¸¦åˆ—å‡¦ç†æ•°ã‚’å¢—ã‚„ã—ã¦é«˜é€ŸåŒ–ã§ãã‚‹ï¼ \
ï¼ç’°å¢ƒå¤‰æ•° `LITELLM_CONCURRENT_CALLS` ã§æŒ‡å®šã—ï¼ŒvLLMãƒ­ã‚°ã«è¡¨ç¤ºã•ã‚Œã‚‹ "Avg generation throughput" ã®å€¤ãŒå¤§ãããªã‚Œã°åŠ¹æœã‚ã‚Šï¼  

> ğŸ—’ï¸ Noteï¼š \
> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯20ï¼

ä¸¦åˆ—å‡¦ç†æ•°ã®ç›®å®‰ã¯ 8Bãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ã‚’ H100 MEM80GB x1 ã§æ¨è«–ã™ã‚‹ã‚±ãƒ¼ã‚¹ã§ 50--100 ãã‚‰ã„ï¼  
ã´ã£ãŸã‚Šæœ€é©åŒ–ã™ã‚‹æ„å‘³ã¯ã‚ã¾ã‚Šãªã„ã®ã§ï¼ŒGPUæšæ•°ã‚„GPUãƒ¡ãƒ¢ãƒªå®¹é‡ã«æ¯”ä¾‹ãŠã‚ˆã³ï¼Œãƒ¢ãƒ‡ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ã«åæ¯”ä¾‹ã•ã›ã¦å¤§é›‘æŠŠã«èª¿æ•´ã™ã‚‹ã¨ã‚ˆã„ï¼

OpenAIãªã©ã®å¤–éƒ¨ãƒ—ãƒ­ãƒã‚¤ãƒ€ã§æ¨è«–ã™ã‚‹å ´åˆã‚‚åŒã˜ã `LITELLM_CONCURRENT_CALLS` ã§ä¸¦åˆ—å‡¦ç†æ•°ã‚’å¢—ã‚„ã›ã‚‹ï¼
APIã®ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆã‚’ç¢ºèªã—ãªãŒã‚‰50--100ãã‚‰ã„ã«èª¿æ•´ã—ã¦ã¿ã¦ã»ã—ã„ï¼

> âš ï¸ æ³¨æ„ï¼š \
> ä¸¦åˆ—å¿œç­”æ•° `n` > 1 ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã«ã¤ã„ã¦ã¯ï¼Œå®Ÿéš›ã®ä¸¦åˆ—å‡¦ç†æ•°ãŒ `LITELLM_CONCURRENT_CALLS` / `n` ã¨å°‘ãªããªã‚‹ï¼  
> ä¾‹ãˆã° n=10 ãªã‚‰ `LITELLM_CONCURRENT_CALLS` ã§æŒ‡å®šã—ãŸä¸¦åˆ—å‡¦ç†æ•°ã®10åˆ†ã®1ã«ãªã‚‹ã®ã§æ³¨æ„ï¼

#### 2) repetitionãŒå¤šç™ºã—ã¦ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãŒæ¥µç«¯ã«ä½ä¸‹ã—ã¦ã„ã‚‹

max-samples=10ãã‚‰ã„ã«è¨­å®šã—ã¦ãƒ¢ãƒ‡ãƒ«ãŒç”Ÿæˆã—ãŸå›ç­”ã‚’çœºã‚ã¦ã¿ã¦ï¼Œå»¶ã€…ã¨åŒã˜æ–‡å­—åˆ—ã‚’ç¹°ã‚Šè¿”ã™repetitionãŒèµ·ãã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¦ã»ã—ã„ï¼  
çµŒé¨“çš„ã«ã¯æ¨è«–å‹ãƒ¢ãƒ‡ãƒ«ï¼ŒãŠã‚ˆã³ LiveCodeBench ã‚„ MATH-500 ãªã©æ•°å­¦ãƒ»ç§‘å­¦ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§repetitionãŒèµ·ãã‚„ã™ã„ï¼  

> ğŸ—’ï¸ Note: \
> repetitionã®å•é¡Œã¯ï¼ŒåŸºæœ¬çš„ã«ã¯è¨ˆç®—è³‡æºã®å¢—å¼·ã§è§£æ±ºã—ãŸã„ï¼\
> ãã‚ŒãŒé›£ã—ã„å ´åˆã«ã¯ï¼Œä¾é ¼è€…ã«å ±å‘Šã—ãŸã†ãˆã§ï¼Œ`MAX_MODEL_LENGTH` ã‚’8,192ã¾ã§ä¸‹ã’ã‚‹ã“ã¨ã§è§£æ±ºã‚’å›³ã£ã¦ã»ã—ã„ï¼\
> æ¨è«–å‹ãƒ¢ãƒ‡ãƒ«ã®å ´åˆã¯ temperature ã‚’0.6ã«ä¸Šã’ãŸã‚Š top_p ã‚’0.95ã«ä¸‹ã’ãŸã‚Šã™ã‚‹é¸æŠè‚¢ã‚‚ã‚ã‚‹ãŒï¼Œãƒ¢ãƒ‡ãƒ«é–“ã®å…¬å¹³æ€§ãŒæãªã‚ã‚Œã‚‹ã®ã§æœ€å¾Œã®æ‰‹æ®µã§ã‚ã‚‹ï¼

#### 3 ) è¨ˆç®—è³‡æºãŒè¶³ã‚Šãªã„

vLLMãƒ­ã‚°ã« `Aborted request` ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ï¼Œã¾ãŸã¯lightevalãƒ­ã‚°ã« `Timeout` ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ï¼Œæ¨è«–ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¦APIå‘¼ã³å‡ºã—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦ã„ã‚‹ï¼  
ã“ã®å ´åˆã¯ç’°å¢ƒå¤‰æ•° `REQUEST_TIMEOUT` ï¼ˆå˜ä½ã¯ç§’ï¼‰ã«ååˆ†ã«å¤§ããªå€¤ã‚’è¨­å®šã™ã‚‹ã“ã¨ï¼

### 3.7 vLLMã®reasoning_parserãŒå¯¾å¿œã—ã¦ã„ãªã„æ¨è«–å‹ãƒ¢ãƒ‡ãƒ«

vLLMã«ã¯æ¨è«–éç¨‹ã‚’é™¤å»ã™ã‚‹ reasoning parser ãŒãƒ“ãƒ«ãƒˆã‚¤ãƒ³ã•ã‚Œã¦ã„ã‚‹ãŒï¼ŒparserãŒå¯¾å¿œã—ã¦ã„ãªã„æ¨è«–å‹ãƒ¢ãƒ‡ãƒ«ã«ã¤ã„ã¦ã¯RuntimeErrorãŒç™ºç”Ÿã™ã‚‹ï¼  

```
# --reasoning-parser=deepseek_r1 ã§ã‚¨ãƒ©ãƒ¼ãŒç”Ÿã˜ãŸä¾‹
RuntimeError: DeepSeek R1 reasoning parser could not locate think start/end tokens in the tokenizer!
```

æ¨è«–éç¨‹ã®é™¤å»ã¯MT-Benchç­‰ã§å¿…é ˆãªã®ã§ï¼Œã“ã®ã‚ˆã†ã«ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã‚‹æ¨è«–å‹ãƒ¢ãƒ‡ãƒ«ã«ã¤ã„ã¦ã¯æˆ‘ã€…ãŒç‹¬è‡ªå®Ÿè£…ã—ãŸ parser ã‚’ lightevalå´ã§é©ç”¨ã—ãŸã„ï¼ \
å…·ä½“çš„ã«ã¯ `vllm serve` ã§ã¯ãªã `lighteval endpoint litellm` ã® MODEL_ARGS ã« `reasoning_parser` ã‚’æŒ‡å®šã—ã¦ã»ã—ã„ï¼  
> ğŸ—’ï¸ Note: \
> custom_model_settings ã§ã¯ vLLM ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ã® parsre ã¨ç‹¬è‡ªå®Ÿè£…ã® parser ã‚’åŒºåˆ¥ã™ã‚‹ã“ã¨ãªãæŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ï¼ \
> ãŸã ã—ï¼Œæ–°ã—ã„ parser ã‚’è¿½åŠ ã—ãŸéš›ã«ã¯ [common_fungs/classify_reasoning_parser](https://github.com/swallow-llm/swallow-evaluation-instruct-private/blob/0d91b7301f66bf46cf55424bf69d16b76c495293/scripts/qsub/common_funcs.sh#L329) ã«é©å®œåæ˜ ã—ã¦æ¬²ã—ã„ï¼

```
# ã‚³ãƒãƒ³ãƒ‰ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
vllm serve
(--reasoning-parser ã‚’æŒ‡å®šã—ãªã„)

lighteval endpoint litellm \
"model=ãƒ¢ãƒ‡ãƒ«å,reasoning_parser={parserå},generation_parameters=..." \
(ä»¥ä¸‹ç•¥)
```


`lighteval endpoint litellm` ã®parserã¯æˆ‘ã€…ãŒç‹¬è‡ªå®Ÿè£…ã—ãŸã‚‚ã®ã§ï¼Œä»¥ä¸‹ã®parserãŒåˆ©ç”¨ã§ãã‚‹ï¼\
æ¨è«–éç¨‹ã®ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ã‚¿ã‚°ã‚’èª¿ã¹ã¦é©åˆ‡ãªã‚‚ã®ã‚’é¸ã‚“ã§ã»ã—ã„ï¼  

|reasoning_parser|æ¨è«–éç¨‹ã®ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—|ãƒ¢ãƒ‡ãƒ«ã®ä¾‹|
|--|--|--|
|deepseek_r1_markup|"\<think\>,\<\/think\>"|Llama-3.1-Nemotron, MiMo-7B-RL|

### 3.8 Baseãƒ¢ãƒ‡ãƒ«ã‚’ç„¡ç†ã‚„ã‚Šè©•ä¾¡ã™ã‚‹

swallow suite ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã¯ã™ã¹ã¦ zero-shot ã‹ã¤ "è€ƒãˆã¦ã‹ã‚‰è§£ã" Instructãƒ¢ãƒ‡ãƒ«ã‚’æƒ³å®šã—ãŸã‚¹ã‚¿ã‚¤ãƒ«ã«ãªã£ã¦ã„ã¦ï¼Œ"ç¶šãã‚’äºˆæ¸¬ã™ã‚‹" Baseãƒ¢ãƒ‡ãƒ«ã‚’æƒ³å®šã—ãŸã‚¹ã‚¿ã‚¤ãƒ«ã§ã¯ãªã„ï¼\
ã—ã‹ã—Mid-trainingã®ã‚ˆã†ã«äº‹å¾Œå­¦ç¿’ã‚’æ„è­˜ã—ãŸäº‹å‰å­¦ç¿’ã‚’ç ”ç©¶ãƒ»å®Ÿè·µã™ã‚‹å ´åˆã¯ï¼ŒBaseãƒ¢ãƒ‡ãƒ«ã«å¯¾ã—ã¦ã‚‚"è€ƒãˆã¦ã‹ã‚‰è§£ã"ã‚¹ã‚¿ã‚¤ãƒ«ã§è©•ä¾¡ã—ãŸã„ã“ã¨ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ï¼ \
ã“ã®ã‚ˆã†ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’æƒ³å®šã—ã¦ï¼Œæœ¬ç¯€ã§ã¯Baseãƒ¢ãƒ‡ãƒ«ã‚’ç„¡ç†ã‚„ã‚Šè©•ä¾¡ã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã™ã‚‹ï¼ \
ãŸã ã— **åœæ­¢æ¡ä»¶ã‚’è¨­å®šã™ã‚‹ã®ãŒé›£ã—ã**ï¼Œã¾ãŸï¼Œè€ƒãˆã¦ã‹ã‚‰è§£ãã‚¹ã‚¿ã‚¤ãƒ«ã®é©å¦ã¯ãƒ¢ãƒ‡ãƒ«æ¬¡ç¬¬ãªã®ã§ï¼Œæ€§è³ªã‚’ã‚ˆãç†è§£ã—ã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«ã®ç ”ç©¶ç”¨é€”ã§ã®ã¿ä½¿ã†ã“ã¨ã‚’ãŠã™ã™ã‚ã™ã‚‹ï¼  

Baseãƒ¢ãƒ‡ãƒ«ã‚’ç„¡ç†ã‚„ã‚Šè©•ä¾¡ã™ã‚‹æ–¹æ³•ã¯ï¼ŒBackendã«ã‚ˆã‚Šç•°ãªã‚‹ï¼  

#### vllm serve & litellm backend ã®å ´åˆ
role:user ã® content ã‚’å¹³æ–‡åŒ–ã™ã‚‹ chat template `./resources/chat_template_base_model.jinja` ã‚’ vllm serve ã® chat-template å¼•æ•°ã«æ¸¡ã™å¿…è¦ãŒã‚ã‚‹ï¼  

```
# chat templateã‚’æŒãŸãªã„Baseãƒ¢ãƒ‡ãƒ«
MODEL="Qwen/Qwen2.5-1.5B"
HOST=localhost
PORT=9001
BASE_URL="http://$HOST:$PORT/v1"
API_KEY="dummy"

# vllmã§ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°
vllm serve $MODEL \
--chat-template ./resources/chat_template_base_model.jinja \
--host "$HOST" \
--port "$PORT"
```

Chat template ã®æŒ¯ã‚‹èˆã„ã‚’ç›®è¦–ã§ç¢ºã‹ã‚ãŸã„æ–¹ã¯ [Chat Template Playground](https://huggingface.co/spaces/huggingfacejs/chat-template-playground) ã‚’ä½¿ã£ã¦ã»ã—ã„ï¼  

lightevalã®å¼•æ•°ã¯ã„ã¤ã‚‚ã©ãŠã‚Šã®å®Ÿè¡Œã‚’ã™ã‚Œã°ã‚ˆã„ï¼  
å¿…è¦ã§ã‚ã‚Œã° `generation_parameters.stop_tokens` ã«ï¼Œã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§åœæ­¢æ–‡å­—åˆ—ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ï¼Ref. [LiteLLMä»•æ§˜æ›¸](https://docs.litellm.ai/docs/completion/input)

```
lighteval endpoint litellm \
    "model=hosted_vllm/$MODEL,api_key=$API_KEY,base_url=$BASE_URL,generation_parameters={stop_tokens:\"def ,__main__\"}" \
    "swallow|swallow_jhumaneval|0|0" \
    --output-dir "$OUTPUT_DIR" \
    --use-chat-template

# stop ã¯ strå‹ã«ã—ã¦ã„ã‚‹ã®ã§ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ãŸäºŒé‡å¼•ç”¨ç¬¦ã‚’ã¤ã‘ã¦ãã ã•ã„ï¼
```

#### vLLMã‚’lightevalã‹ã‚‰ç›´æ¥èµ·å‹•ã™ã‚‹ vllm backend ã®å ´åˆ
`--use-chat-template` å¼•æ•°ã‚’å¤–ã—ã¦ã»ã—ã„ï¼  

```
MODEL="Qwen/Qwen2.5-1.5B"
MAX_MODEL_LENGTH=8192
TEMPERATURE=0.2
TOP_P=0.95

MODEL_ARGS="pretrained=$MODEL,dtype=bfloat16,max_model_length=$MAX_MODEL_LENGTH,generation_parameters={temperature:$TEMPERATURE,top_p:$TOP_P}"
OUTPUT_DIR=data/evals/

# --use-chat-template ã‚’å¤–ã™
lighteval vllm $MODEL_ARGS \
"swallow|swallow_jhumaneval|0|0" \
--output-dir $OUTPUT_DIR \
--save-details
```

### æ¨è«–å‹ãƒ¢ãƒ‡ãƒ«ã® reasoning effort ã‚’æŒ‡å®šã™ã‚‹

ã€Œã©ã®ãã‚‰ã„æ·±ãè€ƒãˆã‚‹ã‹ã€ã‚’åˆ¶å¾¡ã§ãã‚‹o3ã®ã‚ˆã†ãªæ¨è«–å‹ãƒ¢ãƒ‡ãƒ«ã¯ `generation_parameters.reasoning_effort` ã« `low,middle,high` ãªã©ã®å€¤ã‚’æŒ‡å®šã§ãã¾ã™ï¼  
ãŸã ã— reasoning_effort ã¯ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ï¼  

1. litellm ã§å¤–éƒ¨Providerã®API (ä¾‹ï¼š OpenAI API) ã‚’æŒ‡å®šã™ã‚‹å ´åˆ
2. lighteval ã‹ã‚‰ vLLM ã‚’ç›´æ¥èµ·å‹•ã™ã‚‹ `litellm vllm` ã§å®Ÿè¡Œã™ã‚‹å ´åˆ

gpt-oss ã®ã‚ˆã†ãªãƒ¢ãƒ‡ãƒ«ã‚’ `vllm serve` ã§ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆã™ã‚‹å ´åˆã¯ `reasoning_effort` ã¯æŒ‡å®šã§ãã¾ã›ã‚“ï¼  

ä½¿ç”¨ä¾‹ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ï¼  

```
# OpenAI API ã§ o3 ã‚’è©•ä¾¡

API_KEY="{OpenAI APIã‚­ãƒ¼}"
BASE_URL="https://api.openai.com/v1/"
MODEL="openai/o3-2025-04-16"

lighteval endpoint litellm \
"model=$MODEL,api_key=$API_KEY,base_url=$BASE_URL,generation_parameters={reasoning_effort:\"high\"}" \
"swallow|gpqa:diamond|0|0" \
--output-dir "$OUTPUT_DIR"
```
